version: "3.0.0"
name: "F_007_derived_zones"
description: "Functional Test: Derived Zones - Tests K-slot allocation and aggregate fields"

symbol: "BTCUSDT"
tf: "1h"

features:
  atr_14:
    indicator: atr
    params:
      length: 14
  ema_20:
    indicator: ema
    params:
      length: 20

structures:
  exec:
    - type: swing
      key: swing
      params:
        left: 5
        right: 5
    - type: derived_zone
      key: derived_zone
      depends_on:
        swing: swing
      params:
        levels: [0.382, 0.5, 0.618]
        mode: retracement
        max_active: 3        # K = 3 slots
        width_pct: 0.002     # 0.2% zone width

# Engine components tested:
# - Derived zone K-slot allocation
# - Zone aggregate fields (any_active, any_touched, active_count)
# - Zone state management (NONE, ACTIVE, BROKEN)
# - Oldest zone dropping on overflow
actions:
  entry_long:
    all:
      - ["derived_zone.any_active", "==", true]     # At least one zone active
      - ["derived_zone.zone0_state", "!=", "BROKEN"]  # Nearest zone not broken
      - ["close", ">", "ema_20"]                     # Above trend

  exit_long:
    all:
      - ["derived_zone.any_active", "==", false]    # No zones active

risk:
  stop_loss_pct: 1.5
  take_profit_pct: 4.0
  max_position_pct: 100.0

_test_metadata:
  test_id: "F_007"
  category: "derived_structures"
  min_signals: 2
  max_signals: 15
  warmup_bars: 30
  edge_cases:
    - "empty_slots"
    - "max_overflow"
    - "rapid_state_changes"
    - "all_zones_broken"
