version: "3.0.0"
name: "S_S_154_nested_any_all_windows"
description: "Stress Gate 20: 5 indicators + all/any nesting + holds_for + occurred_within (short). ETHUSDT."

symbol: "ETHUSDT"
tf: "15m"
med_tf: "1h"
high_tf: "4h"

account:
  starting_equity_usdt: 10000.0
  max_leverage: 1.0
  margin_mode: isolated_usdt
  min_trade_notional_usdt: 10.0
  fee_model:
    taker_bps: 6.0
    maker_bps: 1.0
  slippage_bps: 2.0

features:
  # Trend indicators
  ema_21:
    indicator: ema
    params: {length: 21}
  ema_50:
    indicator: ema
    params: {length: 50}
  ema_200_4h:
    indicator: ema
    params: {length: 200}
    tf: "4h"

  # Oscillators
  rsi_14:
    indicator: rsi
    params: {length: 14}
  stoch_14_3_3:
    indicator: stoch
    params: {k: 14, d: 3, smooth_k: 3}
  cci_20:
    indicator: cci
    params: {length: 20}

  # Trend strength
  adx_14:
    indicator: adx
    params: {length: 14}

actions:
  entry_short:
    all:
      # HTF filter: price below 4h EMA 200
      - ["close", "<", "ema_200_4h"]
      # Trend confirmation for 3 bars
      - holds_for:
          bars: 3
          expr:
            - ["ema_21", "<", "ema_50"]
      # Complex nested logic: any of these bearish setups
      - any:
          # Setup 1: RSI overbought reversal
          - all:
              - occurred_within:
                  bars: 5
                  expr:
                    - ["rsi_14", ">", 70]
              - ["rsi_14", "<", 65]
          # Setup 2: Stochastic overbought with trend
          - all:
              - [{feature_id: "stoch_14_3_3", field: "stoch_k"}, ">", 75]
              - [{feature_id: "adx_14", field: "adx"}, ">", 20]
          # Setup 3: CCI extreme reversal
          - all:
              - occurred_within:
                  bars: 8
                  expr:
                    - ["cci_20", ">", 100]
              - ["cci_20", "<", 80]

  exit_short:
    any:
      - ["close", ">", "ema_200_4h"]
      - all:
          - ["rsi_14", "<", 25]
          - [{feature_id: "stoch_14_3_3", field: "stoch_k"}, "<", 20]
      - holds_for:
          bars: 2
          expr:
            - ["ema_21", ">", "ema_50"]

position_policy:
  mode: short_only
  exit_mode: signal
  max_positions_per_symbol: 1

risk:
  stop_loss_pct: 2.0
  take_profit_pct: 4.0
  max_position_pct: 10.0

_test_metadata:
  gate: 20
  complexity_pct: 100
  category: "max_complexity"
  direction: "short"
  features_tested:
    - "5_indicators"
    - "nested_all_any"
    - "holds_for"
    - "occurred_within"
    - "multi_tf"
    - "stoch_multi_output"
    - "adx_multi_output"
