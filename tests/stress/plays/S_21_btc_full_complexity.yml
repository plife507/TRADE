version: "3.0.0"
name: "S_21_btc_full_complexity"
description: "Stress Test Gate 5.4: Full Complexity - 100% DSL coverage"

symbol: "BTCUSDT"
timeframes:
  low_tf: "15m"
  med_tf: "15m"
  high_tf: "1h"
  exec: "low_tf"

account:
  starting_equity_usdt: 10000.0
  max_leverage: 1.0
  margin_mode: isolated_usdt
  min_trade_notional_usdt: 10.0
  fee_model:
    taker_bps: 5.5
    maker_bps: 2.0
  slippage_bps: 2.0

features:
  ema_9:
    indicator: ema
    params: {length: 9}
  ema_21:
    indicator: ema
    params: {length: 21}
  ema_50:
    indicator: ema
    params: {length: 50}
  rsi_14:
    indicator: rsi
    params: {length: 14}
  atr_14:
    indicator: atr
    params: {length: 14}
  ema_50_1h:
    indicator: ema
    tf: "1h"
    params: {length: 50}

structures:
  exec:
    - type: swing
      key: swing
      params:
        left: 3
        right: 3
    - type: derived_zone
      key: dz
      depends_on:
        source: swing
      params:
        levels: [0.382, 0.5, 0.618]
        mode: retracement
        max_active: 3
        width_pct: 0.002
  high_tf:
    "1h":
      - type: swing
        key: swing_1h
        params:
          left: 5
          right: 5

# Gate 5.4 (100%): Full DSL Complexity
# Tests:
# - Multi-TF indicators (ema_50_1h)
# - Multi-TF structures (swing on exec + htf)
# - Derived zones with aggregates (dz.any_active)
# - Arithmetic expressions (ema_9 - ema_21)
# - Window operators (count_true)
# - all/any boolean logic
# - Multiple condition types
actions:
  entry_long:
    all:
      # EMA alignment (arithmetic check)
      - [["ema_9", "-", "ema_21"], ">", 0]
      # HTF trend confirmation
      - ["close", ">", "ema_50_1h"]
      # Structure support
      - ["close", ">", "swing_1h.low_level"]
      # Derived zone activity
      - ["dz.any_active", "==", true]
      # RSI confirmation with window
      - count_true:
          bars: 3
          expr:
            all:
              - ["rsi_14", "<", 60]
          min_true: 2

  exit_long:
    any:
      # EMA cross down
      - [["ema_9", "-", "ema_21"], "<", 0]
      # Structure break
      - ["close", "<", "swing.low_level"]
      # Zone invalidation
      - ["dz.any_active", "==", false]

position_policy:
  mode: long_only
  exit_mode: signal

risk:
  stop_loss_pct: 2.0
  take_profit_pct: 5.0
  max_position_pct: 95.0

_test_metadata:
  test_id: "S_21"
  category: "full_complexity"
  gate: "5.4"
  complexity_pct: 100
  min_signals: 1
  max_signals: 50
  warmup_bars: 60
  tests:
    - "multi_tf_indicators"
    - "multi_tf_structures"
    - "derived_zones"
    - "arithmetic_expressions"
    - "window_operators"
    - "boolean_logic"
    - "full_dsl_coverage"
