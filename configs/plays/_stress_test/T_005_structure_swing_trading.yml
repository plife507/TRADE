# T_005: Structure-Based Swing Trading
# Real trading logic: Trade support/resistance from swing pivots + fib levels
# Entry: Price at fibonacci retracement level + swing confirmed + trend up
# Exit: Price breaks below swing low OR hits fib extension
# This tests: swing, fibonacci, trend structures, structure field access

id: T_005_structure_swing_trading
version: "3.0.0"
name: "Stress Test 005: Structure-Based Swing Trading"
description: |
  Classic price action swing trading using market structure.
  - Identify swing highs/lows (support/resistance)
  - Use fibonacci retracements for entries
  - Trend structure confirms direction
  Tests: swing, fibonacci, trend structures, structure output fields.

account:
  starting_equity_usdt: 10000.0
  max_leverage: 4.0
  margin_mode: "isolated_usdt"
  min_trade_notional_usdt: 10.0
  fee_model:
    taker_bps: 6.0
    maker_bps: 2.0
  slippage_bps: 3.0

symbol_universe:
  - "BTCUSDT"

execution_tf: "1h"

features:
  # ===== Indicators =====
  - id: "rsi"
    tf: "1h"
    type: indicator
    indicator_type: rsi
    params:
      length: 14

  - id: "atr"
    tf: "1h"
    type: indicator
    indicator_type: atr
    params:
      length: 14

  # ===== Structures =====
  # Swing detection (5-bar left/right confirmation)
  - id: "swing"
    tf: "1h"
    type: structure
    structure_type: swing
    params:
      left: 5
      right: 5

  # Fibonacci levels from swing range
  - id: "fib"
    tf: "1h"
    type: structure
    structure_type: fibonacci
    depends_on:
      swing: "swing"
    params:
      levels: [0.382, 0.5, 0.618, 0.786]
      mode: retracement

  # Trend direction from swing sequence
  - id: "trend"
    tf: "1h"
    type: structure
    structure_type: trend
    depends_on:
      swing: "swing"
    params: {}

position_policy:
  mode: "long_only"
  max_positions_per_symbol: 1
  allow_flip: false
  allow_scale_in: false
  allow_scale_out: false

blocks:
  - id: entry
    cases:
      - when:
          all:
            # ===== STRUCTURE CONFIRMATION =====
            # Trend is bullish (direction = 1)
            - lhs:
                feature_id: "trend"
                field: "direction"
              op: eq
              rhs: 1
            # Trend established for at least 3 bars
            - lhs:
                feature_id: "trend"
                field: "bars_in_trend"
              op: gte
              rhs: 3
            # Swing high exists (confirmed pivot)
            - lhs:
                feature_id: "swing"
                field: "high_level"
              op: gt
              rhs: 0
            # Price currently above swing low (support)
            - lhs:
                feature_id: "close"
              op: gt
              rhs:
                feature_id: "swing"
                field: "low_level"

            # ===== FIBONACCI ENTRY =====
            # Price near 61.8% retracement (golden ratio entry)
            - lhs:
                feature_id: "close"
              op: near_pct
              rhs:
                feature_id: "fib"
                field: "level_0.618"
              tolerance: 0.015

            # ===== RSI FILTER =====
            # RSI not overbought
            - lhs:
                feature_id: "rsi"
              op: lt
              rhs: 65
        emit:
          - action: entry_long
    else:
      emit:
        - action: no_action

  - id: exit
    cases:
      # Trend reversal
      - when:
          lhs:
            feature_id: "trend"
            field: "direction"
          op: eq
          rhs: -1
        emit:
          - action: exit_long
      # Price breaks below swing low (invalidates structure)
      - when:
          lhs:
            feature_id: "close"
          op: lt
          rhs:
            feature_id: "swing"
            field: "low_level"
        emit:
          - action: exit_long
      # RSI overbought
      - when:
          lhs:
            feature_id: "rsi"
          op: gt
          rhs: 80
        emit:
          - action: exit_long

risk_model:
  stop_loss:
    type: "atr_multiple"
    value: 2.0
    atr_feature_id: "atr"
  take_profit:
    type: "rr_ratio"
    value: 2.5
  sizing:
    model: "percent_equity"
    value: 2.0
    max_leverage: 4.0
