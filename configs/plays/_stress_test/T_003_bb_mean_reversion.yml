# T_003: Bollinger Band Mean Reversion Strategy
# Real trading logic: Buy lower band touches, exit at middle band
# Entry: Price near lower BB + RSI oversold + BB bandwidth not too wide
# Exit: Price reaches middle band OR RSI overbought
# This tests: bbands multi-output, near_pct operator, atr_multiple stop

id: T_003_bb_mean_reversion
version: "3.0.0"
name: "Stress Test 003: Bollinger Band Mean Reversion"
description: |
  Classic mean reversion using Bollinger Bands.
  - Buy when price touches lower band (oversold bounce)
  - Filter: RSI < 35 confirms oversold
  - Filter: Bandwidth not extreme (avoid trending markets)
  - Exit: Price returns to mean (middle band)
  Tests: bbands multi-output, near_pct, ATR stops, holds_for window.

account:
  starting_equity_usdt: 10000.0
  max_leverage: 3.0
  margin_mode: "isolated_usdt"
  min_trade_notional_usdt: 10.0
  fee_model:
    taker_bps: 6.0
    maker_bps: 2.0
  slippage_bps: 3.0

symbol_universe:
  - "BTCUSDT"

execution_tf: "1h"

features:
  # Bollinger Bands (20, 2) - multi-output
  - id: "bb"
    tf: "1h"
    type: indicator
    indicator_type: bbands
    params:
      length: 20
      std: 2.0

  # RSI for oversold confirmation
  - id: "rsi"
    tf: "1h"
    type: indicator
    indicator_type: rsi
    params:
      length: 14

  # ATR for stop loss sizing
  - id: "atr"
    tf: "1h"
    type: indicator
    indicator_type: atr
    params:
      length: 14

position_policy:
  mode: "long_only"
  max_positions_per_symbol: 1
  allow_flip: false
  allow_scale_in: false
  allow_scale_out: false

blocks:
  - id: entry
    cases:
      - when:
          all:
            # Price near lower band (within 0.5%)
            - lhs:
                feature_id: "close"
              op: near_pct
              rhs:
                feature_id: "bb"
                field: "lower"
              tolerance: 0.005
            # RSI oversold (strong mean reversion setup)
            - lhs:
                feature_id: "rsi"
              op: lt
              rhs: 35
            # Bandwidth not extreme (avoid trending)
            # %B (percent_b) between 0 and 0.2 means near lower band
            - lhs:
                feature_id: "bb"
                field: "percent_b"
              op: between
              rhs:
                low: 0.0
                high: 0.25
        emit:
          - action: entry_long
    else:
      emit:
        - action: no_action

  - id: exit
    cases:
      # Target: price reaches middle band (mean)
      - when:
          lhs:
            feature_id: "close"
          op: gte
          rhs:
            feature_id: "bb"
            field: "middle"
        emit:
          - action: exit_long
      # Overbought exit
      - when:
          lhs:
            feature_id: "rsi"
          op: gt
          rhs: 75
        emit:
          - action: exit_long

risk_model:
  stop_loss:
    type: "atr_multiple"
    value: 2.0
    atr_feature_id: "atr"
  take_profit:
    type: "rr_ratio"
    value: 1.5
  sizing:
    model: "percent_equity"
    value: 2.0
    max_leverage: 3.0
