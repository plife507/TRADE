# T_006: Derived Zones Confluence Strategy (Complex)
# Real trading logic: Trade high-probability zones with multiple confirmations
# Entry: Multiple active fib zones + price inside zone + momentum aligned
# Exit: Zone broken OR zone touched + take profit
# This tests: derived_zone K slots, aggregates, guard patterns, count_true

id: T_006_derived_zones_confluence
version: "3.0.0"
name: "Stress Test 006: Derived Zones Confluence"
description: |
  High-probability zone trading using confluence of multiple derived zones.
  - Multiple active fib zones = strong support area
  - Price must be inside or touching an active zone
  - Momentum indicators must align
  Tests: derived_zone K slots, aggregates, guard patterns, count_true, complex all/any.

account:
  starting_equity_usdt: 10000.0
  max_leverage: 3.0
  margin_mode: "isolated_usdt"
  min_trade_notional_usdt: 10.0
  fee_model:
    taker_bps: 6.0
    maker_bps: 2.0
  slippage_bps: 3.0

symbol_universe:
  - "BTCUSDT"

execution_tf: "1h"

features:
  # ===== Indicators =====
  - id: "rsi"
    tf: "1h"
    type: indicator
    indicator_type: rsi
    params:
      length: 14

  - id: "macd"
    tf: "1h"
    type: indicator
    indicator_type: macd
    params:
      fast: 12
      slow: 26
      signal: 9

  - id: "ema_21"
    tf: "1h"
    type: indicator
    indicator_type: ema
    params:
      length: 21

  - id: "atr"
    tf: "1h"
    type: indicator
    indicator_type: atr
    params:
      length: 14

  # ===== Structures =====
  # Base swing detection
  - id: "swing"
    tf: "1h"
    type: structure
    structure_type: swing
    params:
      left: 5
      right: 5

  # Trend for direction bias
  - id: "trend"
    tf: "1h"
    type: structure
    structure_type: trend
    depends_on:
      swing: "swing"
    params: {}

  # Derived zones from swing pivots (K=8 slots)
  - id: "fib_zones"
    tf: "1h"
    type: structure
    structure_type: derived_zone
    depends_on:
      source: "swing"
    params:
      levels: [0.382, 0.5, 0.618, 0.786]
      mode: retracement
      max_active: 8
      width_pct: 0.003
      price_source: mark_close

position_policy:
  mode: "long_only"
  max_positions_per_symbol: 1
  allow_flip: false
  allow_scale_in: false
  allow_scale_out: false

blocks:
  - id: entry
    cases:
      - when:
          all:
            # ===== ZONE CONFLUENCE (Derived Zones) =====
            # At least 2 active zones (confluence)
            - lhs:
                feature_id: "fib_zones"
                field: "active_count"
              op: gte
              rhs: 2
            # Price currently inside an active zone
            - lhs:
                feature_id: "fib_zones"
                field: "any_inside"
              op: eq
              rhs: true
            # Price near the closest active zone lower bound
            - lhs:
                feature_id: "close"
              op: near_pct
              rhs:
                feature_id: "fib_zones"
                field: "closest_active_lower"
              tolerance: 0.01

            # ===== ZONE0 GUARD & QUALITY =====
            # Guard: zone0 must be active (not empty)
            - lhs:
                feature_id: "fib_zones"
                field: "zone0_state"
              op: eq
              rhs: "ACTIVE"
            # Zone0 is fresh (aged < 20 bars)
            - lhs:
                feature_id: "fib_zones"
                field: "zone0_age_bars"
              op: lt
              rhs: 20

            # ===== TREND CONFIRMATION =====
            # Bullish trend direction
            - lhs:
                feature_id: "trend"
                field: "direction"
              op: eq
              rhs: 1

            # ===== MOMENTUM ALIGNMENT =====
            # RSI not overbought
            - lhs:
                feature_id: "rsi"
              op: between
              rhs:
                low: 35
                high: 65
            # MACD histogram positive or turning
            - any:
                - lhs:
                    feature_id: "macd"
                    field: "histogram"
                  op: gt
                  rhs: 0
                # Or histogram was positive recently (momentum building)
                - count_true:
                    bars: 5
                    min_true: 3
                    expr:
                      lhs:
                        feature_id: "macd"
                        field: "histogram"
                      op: gt
                      rhs: 0
            # Price above 21 EMA (bullish bias)
            - lhs:
                feature_id: "close"
              op: gt
              rhs:
                feature_id: "ema_21"
        emit:
          - action: entry_long
    else:
      emit:
        - action: no_action

  - id: exit
    cases:
      # ===== ZONE EXITS =====
      # Any zone touched (potential reversal)
      - when:
          all:
            - lhs:
                feature_id: "fib_zones"
                field: "any_touched"
              op: eq
              rhs: true
            # Only exit if RSI also overbought (confirmation)
            - lhs:
                feature_id: "rsi"
              op: gt
              rhs: 70
        emit:
          - action: exit_long
      # No more active zones (structure broken)
      - when:
          lhs:
            feature_id: "fib_zones"
            field: "active_count"
          op: eq
          rhs: 0
        emit:
          - action: exit_long
      # Zone0 broken (primary zone invalidated)
      - when:
          lhs:
            feature_id: "fib_zones"
            field: "zone0_state"
          op: eq
          rhs: "BROKEN"
        emit:
          - action: exit_long

      # ===== TREND REVERSAL =====
      - when:
          lhs:
            feature_id: "trend"
            field: "direction"
          op: eq
          rhs: -1
        emit:
          - action: exit_long

      # ===== MOMENTUM EXITS =====
      # MACD death cross
      - when:
          lhs:
            feature_id: "macd"
            field: "macd"
          op: cross_below
          rhs:
            feature_id: "macd"
            field: "signal"
        emit:
          - action: exit_long
      # Price breaks below EMA
      - when:
          lhs:
            feature_id: "close"
          op: lt
          rhs:
            feature_id: "ema_21"
        emit:
          - action: exit_long

risk_model:
  stop_loss:
    type: "atr_multiple"
    value: 2.0
    atr_feature_id: "atr"
  take_profit:
    type: "rr_ratio"
    value: 2.0
  sizing:
    model: "percent_equity"
    value: 1.5
    max_leverage: 3.0
